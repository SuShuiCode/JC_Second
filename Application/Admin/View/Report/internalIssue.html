<include file="Common:header" title="后台首页"/>
<div id="page-wrapper">
    <include file="Common:breadcrumb" />
    <div id="page-inner" class="container">
        <div class="search-form">
            <form class="form-inline" method="GET" action="">
                <div class="form-group">
                    <label>中心编号：</label>
                    <input type="text" class="form-control input-sm" name="centreno" value="{$centreno}" />
                    <input type="hidden" name="p" value="1" />
                    开始时间：<input type="text" readonly class="form-control f-datetime input-sm" name="begin_time" value="{$begin_time}"> 结束时间<input type="text" readonly class="form-control f-datetime input-sm" name="end_time" value="{$end_time}" />
                    查找方式：<select class="form-control input-sm" name="sortby">
                    <option value="1" <php>if($sortby==1){echo 'selected';}</php>>按审核日期查找</option>
                    <option value="2" <php>if($sortby==2){echo 'selected';}</php>>按盖章日期查找</option>
                </select>
                </div>
                <button type="submit" class="btn btn-primary btn-sm" >查询</button>
            </form>
        </div>
        <!-- 主要模板 starting -->
        <table class="table table-bordered table-striped table-hover" id="tb">
            <thead>
            <th width="5%">序号</th>
            <th >中心编号</th>
            <th width="16%">审核人/操作时间</th>
            <th width="38%">详情</th>
            <th width="15%">操作</th>
            <th width="15%">签发状态</th>
            </thead>
            <tbody>
            <volist name="rs" id="vo" key="i">
                <tr>
                    <td><if condition="$_GET['p'] eq 0">{$i}
                        <else />{$_GET['p']*10-10+$i}</if></td>
                    <td><if condition="$vo[centreno1] or $vo[centreno2] or $vo[centreno3]">
                        <span style="color: red"><i class="glyphicon glyphicon-star">{$vo.centreno}</i></span>
                        <else />
                        <span>{$vo.centreno}</span></if></td>
                    <td>{$vo.name}/{$vo.verify_time}</td>
                    <td>
                        <if condition="$vo[centreno1] or $vo[centreno2] or $vo[centreno3]">
                            <a href="{:U('/admin/contract/reWriteTest')}?id={$vo.centreno}" class="btn btn-info btn-xs">更改单</a></if>
                        <a href="/admin/manager/contractDetail?id={$vo.centreno}" class="btn btn-info btn-xs">检验受理合同</a>
                        <if condition="mb_substr($vo['centreno'],7,1) eq 'C' ">
                        <a href="{:U('/admin/test/sampleShow')}?id={$vo.centreno}" class="btn btn-info btn-xs" >抽样单</a></if>
                        <a href="javascript:void(0);" class="btn btn-info btn-xs" onclick="recordDetail('{$vo.centreno}')">检测记录</a>

                        <a href="javascript:void(0);" class="btn btn-info btn-xs" name="{$vo.pdf_path}" onclick="return Check(this);">检测报告</a>

                        <a href="/admin/report/priceList?id={$vo.centreno}" class="btn btn-info btn-xs">价格审核</a>
                    </td>
                    <td>
                        <if condition="$vo[status] eq 4">
                            <button name="btn_change" onclick="onUpdate({$vo.id})" class="btn btn-success btn-xs" {$view}><i class="glyphicon glyphicon-ok-circle"></i>签发</button>
                            <button name="btn_change" onclick="onBack({$vo.id})" class="btn btn-danger btn-xs" {$view}><i class="glyphicon glyphicon-remove-circle"></i>退回</button>
                        </if>
                    </td>
                    <td>
                        <if condition="$vo['status'] eq 4">
                            <span>未签发</span>
                            <else />
                            <if condition="$vo['ifback'] eq 1 and $vo['status'] neq 4">
                                <span style="color:red;">已退回前台修改</span>
                                <else />
                            <if condition="$vo['internalpass'] eq 1 and ($vo['status'] eq 5 or $vo['status'] eq 6)">
                            <span style="color: green">{$vo.innername}已签发/{$vo.inner_sign_time}</span></if>
                        </if>
                    </td>
                </tr>
            </volist>
            </tbody>
        </table>
        <div class=" pull-left"><i class="glyphicon glyphicon-star" style="color: red">代表合同有变更</i></div>
        <div class=" pull-right"><nav aria-label="Page navigation" id="pagination">{$pagination}</nav></div>



        <!-- main end-->

    </div>
</div>
</div>
<script type="text/javascript">
    $('.f-datetime').datetimepicker({language:  'zh-CN',format:'yyyy-mm-dd',startView: 2,minView:2,  autoclose:true });
    function onUpdate(id){
        if(!id) return false;
        var _options = {"flag":"error","text":"您确定要签发此项目吗！","buttons":{"ok":{"action":function(){doneUpd(id);}},"cancel":{}}};
        doConfirmDialog(_options);
    }
    function doneUpd(id){
        id.onclick = function() {};
        $.ajax({
            type:"post",
            url:"{:U('/admin/Report/doUpd')}",
            data:{"id":id},
            dataType:"json",
            success:function(ret){
                if(ret.msg=='succ'){
                    var _options = {"text":"签发成功！","action":function(){window.location.reload();}};
                    doAlertDialog(_options);
                }else{
                    var _options = {"text":"签发失败！"};
                    if(data.msg) _options.text = data.msg;
                    doAlertDialog(_options);
                }
            }
        });
    }
    function onBack(id){
        if(!id) return false;
        var _options = {"flag":"error","text":"该项目将被退回修改","buttons":{"ok":{"action":function(){notPass(id);}},"cancel":{}}};
        doConfirmDialog(_options);
    }
    function notPass(id){
        id.onclick = function() {};
        $.ajax({
            type:"post",
            url:"{:U('/admin/Report/doneBack')}",
            data:{"id":id},
            dataType:"json",
            success:function(ret){
                if(ret.msg=='succ'){
                    var _options = {"text":"操作成功！","action":function(){window.location.reload();}};
                    doAlertDialog(_options);
                }else{
                    var _options = {"text":"Error！"};
                    if(data.msg) _options.text = data.msg;
                    doAlertDialog(_options);
                }
            }
        });
    }
    function recordDetail(centreno) {
        var newurl='/admin/test/doPrint.html?id='+centreno+'&type=2';
        console.log(newurl);
        window.open(newurl,'_self');
    }
    function Check(path) {
        var url=path.name;
        if(!url) return false;//获取url
        if(url.indexOf("http")==-1){
            thisHost = location.hostname;
            var newurl='http://'+thisHost+url;
        }else{
            var newurl=url;
        }
        //alert(newurl);
        window.open(newurl);
    }
</script>
<include file="Common:footer" />