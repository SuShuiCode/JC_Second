<include file="Common:header" title="后台首页"/>

<div id="page-wrapper">
    <include file="Common:breadcrumb" />
    <div id="page-inner" class="container">
        <form id="form2" name="form1" method="post" action="">
            <table class="table table-bordered table-striped table-hover">
                <tr >
                    <td  colspan="9" ><p align="center" >委 托 人 填 写 </p></td>
                    <input type="hidden" id="type_status" name="type_status" value="{$type_status}">
                </tr>
                <tr >
                    <td><p align="center" ><span style="color:red; font-size:15px">*</span>委托单位 </p></td>
                    <td colspan="8" >
                        <input name="clientName" type="text" class="form-control"  class="form-control" id="clientName2" size="100" value="{$contract.clientname}"/>
                    </td>
                </tr>
                <tr >
                    <td ><p align="center" ><span style="color:red; font-size:15px">*</span>生产单位 </p></td>
                    <td colspan="8" ><input name="productUnit" type="text" class="form-control"  class="form-control"  id="productUnit2" size="100" value="{$contract.productunit}"/></td>
                </tr>
                <tr >
                    <td ><p align="center" ><span style="color:red; font-size:15px">*</span>样品名称 </p></td>
                    <td  colspan="2"><input name="sampleName" type="text" class="form-control"  id="sampleName2" size="20" value="{$contract.samplename}"/></td>
                    <td  colspan="1"><p align="center" >样品编号 </p></td>
                    <td  colspan="2"><input name="sampleCode" type="text" class="form-control"  id="sampleCode2" size="20" value="{$contract.samplecode}"/></td>
                    <td><p align="center" >等级 </p></td>
                    <td colspan="2"><input type="text" class="form-control"  name="grade" id="grade2" size="5" value="{$contract.grade}"/></td>
                </tr>
                <tr >
                    <td  ><p align="center" >规格型号 </p></td>
                    <td  colspan="2"><input type="text" class="form-control"  name="specification" id="specification2" size="20" value="{$contract.specification}"/></td>
                    <td  colspan="1"><p align="center" >商标 </p></td>
                    <td  colspan="5" ><input type="text" class="form-control"  name="trademark" id="trademark2" value="{$contract.trademark}"/></td>
                </tr>
                <tr >
                    <td><p align="center" >生产日期/批号 </p></td>
                    <td colspan="2"><input type="text" class="form-control" name="productionDate" value="{$contract.productiondate}"/>
                        <!--<input type="text" readonly class="form-control f-datetime input-sm" name="productionDate" value="{$contract.productiondate}"/>-->
                        <!--<input type="text" class="form-control" name="productionDate"/>-->
                    <td colspan="1"><p align="center" ><span style="color:red; font-size:15px">*</span>样品数量 </p></td>
                    <td colspan="5" >
                        <div class="col-xs-4">
                            <input type="text" class="form-control"  name="sampleQuantity" id="sampleQuantity" size="5" value="{$contract.samplequantity}"/>
                        </div>
                        <!--<label>
                          <select name="sampleunti" id="select" value="sampleunti" class="form-control">
                              <option value="kg">kg</option>
                              <option value="g">g</option>
                              <option value="L">L</option>
                              <option value="mL">mL</option>
                          </select>
                      </label>--></td>
                </tr>
                <tr >
                    <td ><p align="center" ><span style="color:red; font-size:15px">*</span>样品状态 </p></td>
                    <td colspan="2"><input type="text" class="form-control"  name="sampleStatus" id="sampleStatus2" value="{$contract.samplestatus}"/></td>
                    <td colspan="1"><p align="center" >粉（料）水比 </p></td>
                    <td colspan="5" ><input type="text" class="form-control"  name="ration" id="ration2" value="{$contract.ration}"/></td>
                </tr>
                <tr >
                    <td valign="center" ><p align="center" ><span style="color:red; font-size:15px">*</span>检验依据 </p></td>
                    <td colspan="8" ><input type="text" class="form-control"  name="testCriteria" id="testCriteria2" size="100" value="{$contract.testcriteria}"/></td>
                </tr>
                <tr >
                    <td valign="center" ><p align="center" ><span style="color:red; font-size:15px">*</span>检验项目 </p></td>
                    <td colspan="8" ><p>
                        <textarea class="form-control"  name="testItem" id="testItem">{$contract.testitem}</textarea>
                        <!--<input name="testItem" type="text" class="form-control"  id="testItem" size="100" value="{$contract.testitem}"/>-->
                    </p></td>
                </tr>
                <tr >
                    <td valign="center" ><p align="center" ><span style="color:red; font-size:15px">*</span>检验类别 </p></td>
                    <td colspan="8" ><p align="center">
                        {$contract.testcategory}
                        <!--<if condition="$contract.testcategory == 委托检验">
                            <input type="radio" name="testCategory" id="testCategory10" value="委托检验" checked="checked"/>委托检验
                            <input type="radio" name="testCategory" id="testCategory11" value="抽样检验" />抽样检验
                            <input type="radio" name="testCategory" id="testCategory12" value="形式检验" />型式检验
                        <elseif condition="$contract.testcategory == 抽样检验" />
                            <input type="radio" name="testCategory" id="testCategory10" value="委托检验" />委托检验
                            <input type="radio" name="testCategory" id="testCategory11" value="抽样检验" checked="checked"/>抽样检验
                            <input type="radio" name="testCategory" id="testCategory12" value="形式检验" />型式检验
                        <else />
                            <input type="radio" name="testCategory" id="testCategory10" value="委托检验" />委托检验
                            <input type="radio" name="testCategory" id="testCategory11" value="抽样检验" />抽样检验
                            <input type="radio" name="testCategory" id="testCategory12" value="形式检验" checked="checked"/>型式检验
                        </if>-->
                    </p></td>
                </tr>
                <tr >
                    <td valign="center" colspan="6" ><p >检验报告是否在本中心网站可查询真伪 ?（www.dmtc.org.cn） </p></td>
                    <td valign="center" colspan="3" ><p >
                        是
                        <input type="hidden" name="ifOnline"  value="1"/>
                    </p></td>
                </tr>
                <tr >
                    <td valign="center" ><p align="center" >报告提交方式 </p></td>
                    <td valign="center" colspan="2"><p >
                        <if condition="$contract.postmethod == 自取">
                            自取
                            <input type="radio" name="postMethod" id="testCategory15" value="自取" checked/>
                            邮寄
                            <input type="radio" name="postMethod" id="testCategory16" value="邮寄" />
                            <else />
                            自取
                            <input type="radio" name="postMethod" id="testCategory15" value="自取" />
                            邮寄
                            <input type="radio" name="postMethod" id="testCategory16" value="邮寄" checked />
                        </if>


                    </p></td>
                    <td colspan="3"><p align="center" >是否同意分包 </p></td>
                    <td  colspan="2"><p >
                        <if condition="$contract.ifsubpackage == 1">
                            是
                            <input type="radio" name="ifSubpackage" id="testCategory17" value="1" checked onclick="pack_remark()" />
                            否
                            <input type="radio" name="ifSubpackage" id="testCategory18" value="0" onclick="pack_remark()" />
                            <else />
                            是
                            <input type="radio" name="ifSubpackage" id="testCategory17" value="1" onclick="pack_remark()" />
                            否
                            <input type="radio" name="ifSubpackage" id="testCategory18" value="0" checked onclick="pack_remark()" />
                        </if>
                    </p></td>
                    <td  colspan="2"><p >
                        <if condition="$contract.ifsubpackage == 1">
                            <input type="text" name="package_remark" id="package_remark" value="{$contract.package_remark}" class="form-control" placeholder="分包备注" />
                            <else />
                            <input type="hidden" name="package_remark" id="package_remark" value="{$contract.package_remark}" class="form-control" placeholder="分包备注" />
                        </if>
                    </p></td>
                </tr>
                <tr >
                    <td  ><p align="center" ><span style="color:red; font-size:15px">*</span>委托人(签字)</p></td>
                    <td  colspan="2"><input name="clientSign" type="text" class="form-control"  id="clientSign2" size="3" value="{$contract.clientsign}"/></td>
                    <td  ><p align="center" >联系电话 </p></td>
                    <td colspan="2" ><input type="text" class="form-control"  name="telephone" id="telephone2" size="8" value="{$contract.telephone}"/></td>
                    <td  ><p align="center" >传真 </p></td>
                    <td colspan="2" ><input type="text" class="form-control"  name="tax" id="tax2" size="11" value="{$contract.tax}" /></td>
                </tr>
                <tr >
                    <td  ><p align="center" >邮政编码 </p></td>
                    <td  colspan="2"><input type="text" class="form-control"  name="postcode" id="postcode2" size="8" value="{$contract.postcode}"/></td>
                    <td  ><p align="center" >E-mail </p></td>
                    <td  colspan="5" ><input type="text" class="form-control"  name="email" id="email2" value="{$contract.email}" /></td>
                </tr>
                <tr >
                    <td valign="center" ><p align="center" >通讯地址 </p></td>
                    <td valign="center" colspan="8" ><input type="text" class="form-control"  name="address" id="address2" size="100" value="{$contract.address}"/></td>
                </tr>
                <tr >
                    <td valign="center" ><p align="center" >备注 </p></td>
                    <td valign="center" colspan="8" >
                        <textarea class="form-control"  name="remark" id="remark">{$contract.remark}</textarea></td>
                </tr>
                <tr >
                    <td   colspan="9" ><p align="center" >中 心 办 公 室 填 写 </p></td>
                </tr>
                <tr >
                    <td valign="center" ><p align="center" ><span style="color:red; font-size:15px">*</span>样品状态及数量 </p></td>
                    <td valign="center" colspan="3"><input type="text" class="form-control"  name="sampleStaQuan" id="sampleStaQuan2" size="20" value="{$contract.samplestaquan}"/></td>
                    <td valign="center" ><p align="center" ><span style="color:red; font-size:15px">*</span>收 样 人 </p></td>
                    <td valign="center" colspan="4" ><input type="text" class="form-control" readonly  name="collector" id="collector2" size="20" value="{$contract.collector}"/></td>
                </tr>
                <tr >
                    <td  ><p align="center" ><span style="color:red; font-size:15px">*</span>中心编号 </p></td>
                    <td   colspan="3" ><p>
                        <input type="text" class="form-control"  name="centreNo" id="centreNo" readonly="readonly" size="9" value="{$contract.centreno}"/>
                        <!--<input name="ifHighQuantity" type="checkbox" value="0" onClick="upVIPCode()"/>
                        是否为优质编码
                        <div id="remainCode" style="display:none;color:red">
                          当前剩余量：<span id="remain"></span>
                        </div>
                        <input type="checkbox" id="spec_checkbox" onclick="special_code()"/>申请特殊编码<br/>
                        <div>
                                <ul id="spe_code" style="display:none">

                              <ul>
                        </div>-->
                    </td>
                    <td  ><p align="center" ><span style="color:red; font-size:15px">*</span>检验费用 </p></td>
                    <td  colspan="4" >
                        <p class="fee_title">参考价格</p>
                        <p class="fee_title">报告应收价格</p>
                        <div>
                            <input name="Arecord" type="text" class="form-control fee_refer"  id="Arecord" size="5" placeholder="A部门" readonly   onClick="Cost('A')" value="{$feeItem.arecord}"/>
                            <input name="RArecord" type="text" class="form-control fee_true type3"  id="RArecord" size="5" placeholder="A部门" value="{$feeItem.rarecord}" onKeyUp="computeSum()"/><p class="hint">A部门</p>
                            <input name="A_id_list" id="A_id_list" type="hidden" value="{$a_id_list}"/>
                            <div class="space">+</div>
                        </div>
                        <div>
                            <input name="Brecord" type="text" class="form-control fee_refer"  id="Brecord" size="5" placeholder="B部门" readonly  onClick="Cost('B')" value="{$feeItem.brecord}"/>
                            <input name="RBrecord" type="text" class="form-control fee_true type3"  id="RBrecord" size="5" placeholder="B部门" value="{$feeItem.rbrecord}" onKeyUp="computeSum()"/><p class="hint">B部门</p>
                            <input name="B_id_list" id="B_id_list" type="hidden" value="{$b_id_list}"/>
                            <div class="space">+</div>
                        </div>
                        <div>
                            <input name="Crecord" type="text" class="form-control fee_refer"  id="Crecord" size="5" placeholder="C部门" readonly  onClick="Cost('C')" value="{$feeItem.crecord}"/>
                            <input name="RCrecord" type="text" class="form-control fee_true type3"  id="RCrecord" size="5" placeholder="C部门" value="{$feeItem.rcrecord}" onKeyUp="computeSum()"/><p class="hint">C部门</p>
                            <input name="C_id_list" id="C_id_list" type="hidden" value="{$c_id_list}"/>
                            <div class="space">+</div>
                        </div>
                        <div>
                            <input name="Drecord" type="text" class="form-control fee_refer"  id="Drecord" size="5" placeholder="D部门" readonly  onClick="Cost('D')" value="{$feeItem.drecord}"/>
                            <input name="RDrecord" type="text" class="form-control fee_true type3"  id="RDrecord" size="5" placeholder="D部门" value="{$feeItem.rdrecord}" onKeyUp="computeSum()"/><p class="hint">D部门</p>
                            <input name="D_id_list" id="D_id_list" type="hidden" value="{$d_id_list}"/>
                            <div class="space">+</div>
                        </div>
                        <div>
                            <input name="Erecord" type="text" class="form-control fee_refer"  id="Erecord" size="5" placeholder="E部门" readonly  onClick="Cost('E')" value="{$feeItem.erecord}"/>
                            <input name="RErecord" type="text" class="form-control fee_true type3"  id="RErecord" size="5" placeholder="E部门" value="{$feeItem.rerecord}" onKeyUp="computeSum()"/><p class="hint">E部门</p>
                            <input name="E_id_list" id="E_id_list" type="hidden" value="{$e_id_list}"/>
                            <div class="space">+</div>
                        </div>
                        <div>
                            <input name="Frecord" type="text" class="form-control fee_refer"  id="Frecord" size="5" placeholder="F部门" readonly  onClick="Cost('F')" value="{$feeItem.frecord}"/>
                            <input name="RFrecord" type="text" class="form-control fee_true type3"  id="RFrecord" size="5" placeholder="F部门" value="{$feeItem.rfrecord}" onKeyUp="computeSum()"/><p class="hint">F部门</p>
                            <input name="F_id_list" id="F_id_list" type="hidden" value="{$f_id_list}"/>
                            <div class="space">+</div>
                        </div>
                        <div>
                            <input name="G1record" type="text" class="form-control fee_refer"  id="G1record" size="5" placeholder="G1部门" readonly  onClick="Cost('G1')" value="{$feeItem.g1record}"/>
                            <input name="RG1record" type="text" class="form-control fee_true type3"  id="RG1record" size="5" placeholder="G1部门" value="{$feeItem.rg1record}" onKeyUp="computeSum()"/><p class="hint">G1部门</p>
                            <input name="G1_id_list" id="G1_id_list" type="hidden" value="{$g1_id_list}"/>
                            <div class="space">+</div>
                        </div>
                        <div>
                            <input name="G2record" type="text" class="form-control fee_refer"  id="G2record" size="5" placeholder="G2部门" readonly  onClick="Cost('G2')" value="{$feeItem.g2record}"/>
                            <input name="RG2record" type="text" class="form-control fee_true type3"  id="RG2record" size="5" placeholder="G2部门" value="{$feeItem.rg2record}" onKeyUp="computeSum()"/><p class="hint">G2部门</p>
                            <input name="G2_id_list" id="G2_id_list" type="hidden" value="{$g2_id_list}"/>
                            <div class="space">+</div>
                        </div>
                        <div>
                            <input name="Hrecord" type="text" class="form-control fee_refer"  id="Hrecord" size="5" placeholder="H部门" readonly  onClick="Cost('H')" value="{$feeItem.hrecord}"/>
                            <input name="RHrecord" type="text" class="form-control fee_true type3"  id="RHrecord" size="5" placeholder="H部门" value="{$feeItem.rhrecord}" onKeyUp="computeSum()"/><p class="hint">H部门</p>
                            <input name="H_id_list" id="H_id_list" type="hidden" value="{$h_id_list}"/>
                            <div class="space">+</div>
                        </div>
                        <div class="fee_bor">
                            <p align="center">备注</p>
                            <textarea class="form-control fee type3" rows="10" name="fee_remark">{$feeItem.remark}</textarea>
                        </div>
                        <div class="fee_bor_right">
                            <div>
                                <input name="Dcopy" type="text" class="form-control fee_true_two fee type3"  id="Dcopy" placeholder="副本" onKeyUp="computeSum()" value="{$feeItem.dcopy}"/><p class="hint">副本</p>
                                <div class="space_two">+</div>
                            </div>
                            <div>
                                <input name="Donline" type="text" class="form-control fee_true_two type3"  id="Donline" placeholder="上网费" onKeyUp="computeSum()" value="{$feeItem.donline}" readonly/><p class="hint">上网</p>
                                <div class="space_two">+</div>
                            </div>
                            <div>
                                <input name="Drevise" type="text" class="form-control fee_true_two fee type3"  id="Drevise" placeholder="项目修改" onKeyUp="computeSum()" value="{$feeItem.drevise}" /><p class="hint">修改</p>
                                <div class="space_two">+</div>
                            </div>
                            <div>
                                <input name="Dother" type="text" class="form-control fee_true_two fee type3"  id="Dother" placeholder="其他"  onKeyUp="computeSum()" value="{$feeItem.dother}"/><p class="hint">其他</p>
                                <div class="space_two">=</div>
                            </div>
                            <div>
                                <input name="testCost" type="text" class="form-control fee_true_two"  id="sumCost" placeholder="总计"  value="{$contract.testcost}" readonly />
                                <div class="space_two"></div>
                            </div>
                        </div>
                    </td>
                </tr>
                <tr >
                    <td  ><p align="center" ><span style="color:red; font-size:15px">*</span>收样日期 </p></td>
                    <td  colspan="3" ><p >

                        <div class="form-group">
                            <input type="text" readonly class="form-control" name="collectDate" value="{$contract.collectdate}">
                        </div>
                        </p></td>
                    <td valign="center" ><p align="center" ><span style="color:red; font-size:15px">*</span>报告日期<u> </u></p></td>
                    <td  colspan="4" ><p><input type="text" readonly class="form-control f-datetime" name="reportDate" value="{$contract.reportdate}"></p></td>
                </tr>
                <tr >
                    <td valign="center" ><p >说明 </p></td>
                    <td  colspan="8" ><ol>
                        <li>委托人应对所提供的资料、信息和样品的真实性负责。 </li>
                        <li>若对本单内容有变动，请委托方电话、邮件、传真通知受理人。 </li>
                        <li>本中心仅对来样负责。 </li>
                        <li>委托方要求取走剩余样品时，若在收到检验报告后一个月内未取回，且没有说明情况的，剩余样品由中心统一处理；样品取走后不再受理异议申诉。 </li>
                    </ol></td>
                </tr>
            </table>

            <!-- <button class="btn btn-success" type="button" id="sampling_list" on>生成抽样单</button>-->
            <button class="btn btn-success" type="button" id="check_list" onClick="doEditContract()">申请修改</button>
        </form>
    </div>
    <div>
        <!-- 模态框（Modal） -->
        <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" data-backdrop="static">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">
                            &times;
                        </button>
                        <h4 class="modal-title" id="myModalLabel">
                            费用管理
                        </h4>
                        <div class="col-sm-10 search">
                            <input type="text" class="form-control col-sm-10 standard type3" placeholder="请输入标准号" id="criteria">
                            <button class="btn btn-primary search_btn "  onclick="findCriteria()" >搜索</button>
                            <input type="hidden" id="depar" value="" />
                        </div>
                    </div>
                    <div class="modal-body main_content sco">
                        <!--折叠的大div，在一个大的id下折叠会相互影响，id与a标签的date-parent相关联-->
                        <div class="panel-group" id="accordion222">

                        </div>
                    </div>
                    <div class="modal-footer">
                        <div class="select_opion" id="footer">

                        </div>
                        <p class="fis">总金额：<span id="fee_sum"></span></p>
                        <button type="button" class="btn btn-default" onclick="clearChose()">
                            清空选择
                        </button>
                        <button type="button" class="btn btn-primary" onclick="returnCost()" data-dismiss="modal">
                            提交更改
                        </button>
                    </div>
                </div>
                <!-- /.modal-content -->
            </div>
            <!-- /.modal -->
        </div>
    </div>
</div>

<script src="__PUBLIC__/static/js/jquery.form.js"></script>
<script type="text/javascript">

    $(document).ready(function(){
        //计算费用
        var type_status = $('#type_status').val();
        if(type_status == 6){
            $('input,select,textarea').prop('disabled',true);
            $('.fee').prop('disabled',false);
            $('#sumCost').prop('disabled',false);
            $('#centreNo').prop('disabled',false);
            $('#sumCost').prop('readonly',true);
            $('#centreNo').prop('readonly',true);
        }

        if(type_status == 3){
            $('input,select,textarea').prop('readonly',true);
            $('.type3').prop('readonly',false);
            $('input[name=reportDate]').removeClass("f-datetime");
        }
        $('.f-datetime').datetimepicker({language:  'zh-CN',format:'yyyy-mm-dd',startView: 2,minView:2,	autoclose:true });

    });

    //实时计算总费用
    function computeSum(){
        var sum =0 ;
        if($("#RArecord").val()!="" && $.trim($("#RArecord").val()).length>0){
            sum+=parseInt($("#RArecord").val());
        }
        if($("#RBrecord").val()!="" && $.trim($("#RBrecord").val()).length>0){
            sum+=parseInt($("#RBrecord").val());
        }
        if($("#RCrecord").val()!="" && $.trim($("#RCrecord").val()).length>0){
            sum+=parseInt($("#RCrecord").val());
        }
        if($("#RDrecord").val()!="" && $.trim($("#RDrecord").val()).length>0){
            sum+=parseInt($("#RDrecord").val());
        }
        if($("#RErecord").val()!="" && $.trim($("#RErecord").val()).length>0){
            sum+=parseInt($("#RErecord").val());
        }
        if($("#RFrecord").val()!="" && $.trim($("#RFrecord").val()).length>0){
            sum+=parseInt($("#RFrecord").val());
        }
        if($("#RGrecord").val()!="" && $.trim($("#RGrecord").val()).length>0){
            sum+=parseInt($("#RGrecord").val());
        }
        if($("#RHrecord").val()!="" && $.trim($("#RHrecord").val()).length>0){
            sum+=parseInt($("#RHrecord").val());
        }
        if($("#Dcopy").val()!="" && $.trim($("#Dcopy").val()).length>0){
            sum+=parseInt($("#Dcopy").val());
        }
        if($("#Donline").val()!="" && $.trim($("#Donline").val()).length>0){
            sum+=parseInt($("#Donline").val());
        }
        if($("#Drevise").val()!="" && $.trim($("#Drevise").val()).length>0){
            sum+=parseInt($("#Drevise").val());
        }
        if($("#Dother").val()!="" && $.trim($("#Dother").val()).length>0){
            sum+=parseInt($("#Dother").val());
        }
        $("#sumCost").val(sum);
    }


    //合同修改
    function doEditContract(){
        if(confirm("确认申请吗？")){
            computeSum();
            var type_status = $('#type_status').val();
            var options = {
                url: "{:U('/admin/contract/doApplyContract')}",
                dataType: 'json',
                data:{'type_status':type_status},
                beforeSubmit: function(){
                    return true;
                },
                success: function (data) {
                    /*if(data.msg=='succ'){
                     var _options = {"text":"修改成功！","action":function(){window.location.href="/admin/contract/showList";}};
                     doAlertDialog(_options);
                     }else{
                     var _options = {"text":"修改失败！"};
                     if(data.msg) _options.text = data.msg;
                     doAlertDialog(_options);
                     }*/
                    if(data.msg=='exist'){
                        alert("该合同正在申请中，无需再次申请！");
                        return;
                    }else if(data.msg=="none"){
                        alert("您没有修改内容，无法申请");
                        return;
                    }
                    else alert(data.msg);
                }
            };
            $("#form2").ajaxSubmit(options);
        }
    }
    //分包备注是否显示
    function pack_remark(){
        if($("input:radio[name='ifSubpackage']:checked").val()==1){
            $("input[name=package_remark]").attr('type','text');
        }else{
            $("input[name=package_remark]").val("");
            $("input[name=package_remark]").attr('type','hidden');
        }
    }

    <!-----------------------------------本部门费用 start----------------------------------- -->

    //本部门费用选
    function Cost(de){
        //var modal = $("#editModal_"+de);
        //setMetOption(de);
        $('#myModal').modal({
            keyboard: true,
        });
        $("#depar").val(de);
        $("#footer").html("");
        $("#fee_sum").html("");
        $("#accordion222").html("");
        $("#criteria").val("");

    }

    //查询标准号
    function findCriteria(){
        clearChose();
        var criteria = $("#criteria").val();
        criteria = criteria.replace(/\s/g,"");
        console.log(criteria);
        $.ajax({
            url: "{:U('/admin/contract/findCriteria')}",
            dataType: 'json',
            data:{'criteria':criteria},
            beforeSubmit: function(){
                return true;
            },
            success: function (re) {
                var html_list="";
                data_criteria = re['criteria_list'];
                data_productname = re['productname_list'];
                for(var i = 0;i<data_criteria.length;i++){
                    var html_productname = "";
                    for(var j=0;j<data_productname[i].length;j++){
                        data_criteria_name = data_criteria[i]['criteria'];
                        if(data_productname[i][j]['productname']==""){
                            data_productname[i][j]['productname']="全项(多个产品名称)";
                        }
                        html_productname += '<div class="panel panel-default"><div class="panel-heading"><h4 class="panel-title"><a data-toggle="collapse" data-parent="#accordion_'+i+'" href="#collapseOne_'+i+j+'" onclick=findProItem("'+i+j+'","'+encodeURIComponent(data_criteria_name)+'","'+encodeURIComponent(data_productname[i][j]['productname'])+'")>'+data_productname[i][j]['productname']+'</a></h4></div><div id="collapseOne_'+i+j+'" class="panel-collapse collapse"><div class="panel-body"><form class="checkbox-inlin form_item" role="form" id="form_'+i+j+'"></form></div></div></div>';

                    }
                    html_list += '<div class="panel panel-default" id="fee_list_'+i+'"><div class="panel-heading"><h4 class="panel-title"><a data-toggle="collapse" data-parent="#accordion222" href="#collapseOne_'+i+'">'+data_criteria[i]['criteria']+'</a></h4></div><div id="collapseOne_'+i+'" class="panel-collapse collapse"><div class="panel-body"><div class="panel-group" id="accordion_'+i+'">'+html_productname+'</div></div></div></div>';
                    $("#accordion222").html(html_list);

                }
                if(data_criteria.length==0){
                    $("#accordion222").html("<span style='color:grey'>无此标准号</span>");
                }
            }
        });

    }

    //获取指定产品名称的编号
    function findProItem(ij,criteria,productname){
        //alert(ij,criteria,productname);
        criteria = decodeURIComponent(criteria);
        criteria = criteria.replace(/\s/g,"");
        productname = decodeURIComponent(productname);
        if(productname == "全项(多个产品名称)"){
            data={'criteria':criteria,'productname':'null'};
        }else{
            data={'criteria':criteria,'productname':productname};
        }
        var p_id = "collapseOne_"+ij;
        var form_id = "form_"+ij;
        if($("#"+form_id+" input").length==0){
            $.ajax({
                url: "{:U('/admin/contract/findItem')}",
                dataType: 'json',
                data:data,
                beforeSubmit: function(){
                    return true;
                },
                success: function (re) {
                    var item_list = re['item_list'];
                    var html_list = "";
                    var button_list = "";
                    for(var i=0 ;i<item_list.length;i++){
                        items_name = item_list[i]['item'];
                        items_id = item_list[i]['id'];
                        items_quantity = item_list[i]['quantity'];
                        items_fee = item_list[i]['fee'];
                        if(items_quantity==1){
                            html_list += '<input type="checkbox" id="items_'+items_id+'" name="items" value="'+items_fee+'" onchange=valid(this.id,"'+encodeURIComponent(items_name)+'","'+form_id+'")>'+items_name+'('+items_fee+')';
                        }else if(items_quantity==2){
                            button_list +=  '<button type="button" class="btn btn-default btn-xs" id="items_all_'+items_id+'" name="items_all" value="'+items_fee+'" onclick=checkAllFee(this.id,"'+encodeURIComponent(items_name)+'","'+form_id+'")>'+items_name+'</button>';
                        }
                    }
                    html_list = button_list+"<br/>"+html_list;
                    $("#"+p_id+" #"+form_id).html(html_list);
                }
            });
        }
    }

    //单项点击定位
    function valid(num,name,parent) {
        //console.log(num)
        var input_id = "#" + num;
        var input_parent_id = "#" + parent;
        var input_class = "." + parent + "_" +num;
        name = decodeURIComponent(name);
        var b_id_list =[];
        //if($(input_id)[0].checked) {
        //alert(input_parent_id+" "+input_id);
        //alert($(input_parent_id+" "+input_id).prop('checked'));
        if($(input_parent_id+" "+input_id).prop('checked')==true) {
            if(!$('#footer').children().hasClass(parent + "_" +num)){
                $('#footer').append("<span class=" + parent + "_" +num + ">" + name + "(" +$(input_parent_id+" "+input_id).val() + ")" + "&nbsp;&nbsp;&nbsp;</span>");
            }
        } else {
            $(input_class).remove();
        }
        checkFee();
    }

    //单项选择
    function checkFee(){
        cash = 0;

        $("form.form_item").each(function(index, element) {
            var flag_all = false;
            var form_id = $(this).attr("id");
            //console.log(form_id);
            $("#"+form_id+" "+"button[name=items_all]").each(function(index, element) {
                var id = $(this).attr("id");
                var flag = true;
                if($(this).siblings().hasClass(id)){
                    $("#"+form_id+" "+"."+id).each(function(index, element) {
                        if($(this).prop("checked") == false){
                            flag = false;
                        }
                    });
                    if(flag == true){
                        flag_all = true;
                        $("#"+form_id+" "+"input[name='items']").each(function(index, element) {
                            if(!$(this).hasClass(id) && $(this).prop("checked") == true){
                                cash+=parseInt(element.value);
                            }
                        });
                        cash += parseInt($(this).val());
                    }
                }

            });
            //console.log("flag_all"+flag_all);
            if(!flag_all){
                $("#"+form_id+" "+"input[name='items']").each(function(index, element) {
                    if($(this).prop("checked") == true){
                        cash+=parseInt(element.value);
                    }
                });
            }
        });


        $("#fee_sum").html(cash);
    }


    //计算本部门费用--全项选择
    function checkAllFee(num,name,parent){
        var cash=0;
        var item_id;
        name = decodeURIComponent(name);
        item_id = num.replace("items_all_","");

        $.ajax({
            url: "{:U('/admin/contract/findAllItem')}",
            dataType: 'json',
            data:{'item_id':item_id},
            beforeSubmit: function(){
                return true;
            },
            success: function (re) {
                //console.log(re);
                var fee_item = re['fee_item'];
                var child_item_list = fee_item['child_item_list'];
                var fee = fee_item['fee'];
                var id_list = child_item_list.split(",");
                $("#"+parent+" input[name=items]").prop('checked',false);
                $("#"+parent+" input[name=items]").trigger('onchange');
                $("#"+parent+" input[name=items]").attr('class',"");
                //$("#footer").empty();
                for(var i=0;i<id_list.length;i++){
                    $("#"+parent+" #items_"+id_list[i]).prop('checked',true);
                    //$("#items_"+id_list[i]).addClass(num);
                    $("#"+parent+" #items_"+id_list[i]).attr('class',num);
                    $("#"+parent+" #items_"+id_list[i]).trigger("onchange");
                    //id = "items_"+id_list[i];
                    //$('#footer').append("<span class=" + id + ">" + $("#"+id).attr('name') + "(" +$("#"+id).val() + ")" + "&nbsp;&nbsp;&nbsp;</span>");
                }
                //$("#fee_sum").html(fee);
            }
        });
    }

    function returnCost(){
        var de = $("#depar").val();
        $("#"+de+"record").val($("#fee_sum").html());
        id_list =[];
        $("input[name='items']").each(function(index, element) {
            if($(this).prop("checked") == true){
                id = element.id.replace("items_","");
                id_list.push(id);
            }
        });
        $("#"+de+"_id_list").val(id_list.join(","));
        //computeSum();
    }

    function clearChose(){
        $("#accordion222 input[name=items]").prop('checked',false);
        $("#footer").html("");
        $("#fee_sum").html("");
    }

    <!-----------------------------------费用 end----------------------------------- -->



</script>
</body>