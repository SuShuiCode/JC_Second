<include file="Common:header" title="后台首页"/>

<div id="page-wrapper">
	<include file="Common:breadcrumb" />
    <div id="page-inner" class="container">
      <form id="form2" name="form1" method="post" action="">
        <table class="table table-bordered table-striped table-hover">
          <tr >
            <td  colspan="9" ><p align="center" >委 托 人 填 写 </p></td>
          </tr> 
          <tr > 
            <td><p align="center" >委托单位 </p></td>
            <td colspan="8" >
                <input name="clientName" type="text" class="form-control"  class="form-control" id="clientName2" size="100" />       
            </td>
          </tr> 
          <tr > 
            <td ><p align="center" >生产单位 </p></td>
            <td colspan="8" ><input name="productUnit" type="text" class="form-control"  class="form-control"  id="productUnit2" size="100"/></td>
          </tr> 
          <tr > 
            <td ><p align="center" >样品名称 </p></td>
            <td  colspan="2"><input name="sampleName" type="text" class="form-control"  id="sampleName2" size="20" /></td>
            <td  colspan="1"><p align="center" >样品编号 </p></td>
            <td  colspan="2"><input name="sampleCode" type="text" class="form-control"  id="sampleCode2" size="20" /></td>
            <td><p align="center" >等级 </p></td>
            <td colspan="2"><input type="text" class="form-control"  name="grade" id="grade2" size="5"/></td>
          </tr>
          <tr >
            <td  ><p align="center" >规格型号 </p></td>
            <td  colspan="2"><input type="text" class="form-control"  name="specification" id="specification2" size="20"/></td>
            <td  colspan="1"><p align="center" >商标 </p></td>
            <td  colspan="5" ><input type="text" class="form-control"  name="trademark" id="trademark2" /></td>
          </tr>
          <tr >
            <td><p align="center" >生产日期/批号 </p></td>
            <td colspan="2"><input type="text" readonly class="form-control f-datetime input-sm" name="productionDate"/>
            <td colspan="1"><p align="center" >样品数量 </p></td>
            <td colspan="5" >
            	<div class="col-xs-4">
            		<input type="text" class="form-control"  name="sampleQuantity" id="sampleQuantity" size="5"/>
                </div>
              <label>
                <select name="sampleunti" id="select" value="sampleunti" class="form-control">
                	<option value="kg">kg</option>
                    <option value="g">g</option>
                    <option value="L">L</option>
                    <option value="mL">mL</option>
                </select>
            </label></td>
          </tr>
          <tr >
            <td ><p align="center" >样品状态 </p></td>
            <td colspan="2"><input type="text" class="form-control"  name="sampleStatus" id="sampleStatus2" /></td>
            <td colspan="1"><p align="center" >粉（料）水比 </p></td>
            <td colspan="5" ><input type="text" class="form-control"  name="ration" id="ration2" /></td>
          </tr>
          <tr >
            <td valign="center" ><p align="center" >检验依据 </p></td>
            <td colspan="8" ><input type="text" class="form-control"  name="testCriteria" id="testCriteria2" size="100"/></td>
          </tr>
          <tr >
            <td valign="center" ><p align="center" >检验项目 </p></td>
            <td colspan="8" ><p>
              <input name="testItem" type="text" class="form-control"  id="testItem" size="100"/>
            </p></td>
          </tr>
          <tr >
            <td valign="center" ><p align="center" >检验类别 </p></td>
            <td colspan="8" ><p align="center" >
              <input type="radio" name="testCategory" id="testCategory10" value="委托检验" checked="checked"/>委托检验
              
              <input type="radio" name="testCategory" id="testCategory11" value="抽样检验" />抽样检验
              
              <input type="radio" name="testCategory" id="testCategory12" value="形式检验" />型式检验
            </p></td>
          </tr>
          <tr >
            <td valign="center" colspan="6" ><p >检验报告是否在本中心网站可查询真伪 ?（www.dmtc.org.cn） </p></td>
            <td valign="center" colspan="3" ><p >是
              <input type="radio" name="ifOnline" id="testCategory13" value="1" />
              否
              <input type="radio" name="ifOnline" id="testCategory14" value="0" />
            </p></td>
          </tr>
          <tr >
            <td valign="center" ><p align="center" >报告提交方式 </p></td>
            <td valign="center" colspan="2"><p >自取
              <input type="radio" name="postMethod" id="testCategory15" value="自取" />
              邮寄
              <input type="radio" name="postMethod" id="testCategory16" value="邮寄" />
            </p></td>
            <td colspan="3"><p align="center" >是否同意分包 </p></td>
            <td  colspan="3"><p >是
              <input type="radio" name="ifSubpackage" id="testCategory17" value="1" />
              否
              <input type="radio" name="ifSubpackage" id="testCategory18" value="0" />
            </p></td>
          </tr>
          <tr >
            <td  ><p align="center" >委托人(签字)</p></td>
            <td  colspan="2"><input name="clientSign" type="text" class="form-control"  id="clientSign2" size="3" /></td>
            <td  ><p align="center" >联系电话 </p></td>
            <td colspan="2" ><input type="text" class="form-control"  name="telephone" id="telephone2" size="8"/></td>
            <td  ><p align="center" >传真 </p></td>
            <td colspan="2" ><input type="text" class="form-control"  name="tax" id="tax2" size="11" /></td>
          </tr>
          		  <tr >
            <td  ><p align="center" >邮政编码 </p></td>
            <td  colspan="2"><input type="text" class="form-control"  name="postcode" id="postcode2" size="8"/></td>
            <td  ><p align="center" >E-mail </p></td>
            <td  colspan="5" ><input type="text" class="form-control"  name="email" id="email2" /></td>
          </tr>
          <tr >
            <td valign="center" ><p align="center" >通讯地址 </p></td>
            <td valign="center" colspan="8" ><input type="text" class="form-control"  name="address" id="address2" size="100"/></td>
          </tr>
          <tr >
            <td valign="center" ><p align="center" >备注 </p></td>
            <td valign="center" colspan="8" >
            <textarea class="form-control"  name="remark" id="remark"></textarea></td>
          </tr>
          <tr >
            <td   colspan="9" ><p align="center" >中 心 办 公 室 填 写 </p></td>
          </tr>
          <tr >
            <td valign="center" ><p align="center" >样品状态及数量 </p></td>
            <td valign="center" colspan="3"><input type="text" class="form-control"  name="sampleStaQuan" id="sampleStaQuan2" size="20"/></td>
            <td valign="center" ><p align="center" >收 样 人 </p></td>
            <td valign="center" colspan="4" ><input type="text" class="form-control"  name="collector" id="collector2" size="20"/></td>
          </tr>
          <tr >
            <td  ><p align="center" >中心编号 </p></td>
            <td   colspan="3" ><p>
              <input type="text" class="form-control"  name="centreNo" id="centreNo" readonly="readonly" size="9"/>
              <!--<input type="button" name="button2" id="button2" value="生成中心编码" />-->
              <input name="ifHighQuantity" type="checkbox" value="0" onClick="upVIPCode()"/>
              是否为优质编码
              <div id="remainCode" style="display:none;color:red">
                当前剩余量：<span id="remain"></span>
              </div>
              <button class="btn btn-success" type="button">申请特殊编码</button>
            </p></td>
            <td  ><p align="center" >检验费用 </p></td>
            <td  colspan="4" >
              <div class="col-xs-5">
              	<input name="testCost1" type="text" class="form-control"  id="myCost" size="5" placeholder="本部门" readonly onChange="computeSum()"  onClick="myCost1()"/>
                +
              <input name="testCost2" type="text" class="form-control"  id="dCost" size="5" placeholder="D部门" readonly onChange="computeSum()"  onClick="dCost1()"/>
              +
              <input name="testCost3" type="text" class="form-control"  id="copyCost" placeholder="副本" onKeyUp="computeSum()" size="5" />
              +
              <input name="testCost4" type="text" class="form-control"  id="editCost" placeholder="修改" onKeyUp="computeSum()" size="5" />
              =
              <input name="testCost" type="text" class="form-control"  id="sumCost" placeholder="总计"  size="8" readonly /></td>
              </div>
              
          </tr>
          <tr >
            <td  ><p align="center" >收样日期 </p></td>
            <td  colspan="3" ><p >
            
            <div class="form-group">
				 <input type="text" readonly class="form-control f-datetime input-sm" name="collectDate">
				  	</div>
            </p></td>
            <td valign="center" ><p align="center" >报告日期<u> </u></p></td>
            <td  colspan="4" ><p ><input type="text" readonly class="form-control f-datetime input-sm" name="reportDate"></p></td>
          </tr>
          <tr >
            <td valign="center" ><p >说明 </p></td>
            <td  colspan="8" ><ol>
              <li>委托人应对所提供的资料、信息和样品的真实性负责。 </li>
              <li>若对本单内容有变动，请委托方电话、邮件、传真通知受理人。 </li>
              <li>本中心仅对来样负责。 </li>
              <li>委托方要求取走剩余样品时，若在收到检验报告后一个月内未取回，且没有说明情况的，剩余样品由中心统一处理；样品取走后不再受理异议申诉。 </li>
            </ol></td>
          </tr>
        </table>
        
        <button class="btn btn-success" type="button" id="sampling_list" on>生成抽样单</button>
        <button class="btn btn-success" type="submit" id="check_list" onClick="doInputContract()">合同录入</button>
      </form>
    </div>
    
</div>

<!-- 模态框（Modal) -->
<div class="modal fade" id="editModal" tabindex="-1" role="dialog" aria-labelledby="editModal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
        <form class="form-horizontal" id="myform" action="" method="post">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                <h4 class="modal-title" id="createModalLabel">本部门费用</h4>
            </div>
            <div class="form-group form-group-sm">
             		<label class="col-sm-3 control-label talign-right fz13">材料</label>
				    <div class="col-sm-7">
				    	<select name="meterial" class="form-control" id="meterial" onchange="setProOption()">
				    		<option value=0>请选择</option>
				    	</select>
				    </div>
                    <div class="clearfix"></div>
            </div>
            <div class="form-group form-group-sm">
             		<label class="col-sm-3 control-label talign-right fz13">产品名称</label>
				    <div class="col-sm-7">
				    	<select name="productname" class="form-control" id="productname" onchange="setItemOption()">
				    		<option value=0>请选择</option>
				    	</select>
				    </div>
                    <div class="clearfix"></div>
            </div>
            <div class="form-group form-group-sm">
             		<label class="col-sm-3 control-label talign-right fz13">测试项目</label>
				    <div class="col-sm-7" id="items">
				    	
				    </div>
                    <div class="clearfix"></div>
            </div>
            <div class="form-group form-group-sm">
             		<label class="col-sm-3 control-label talign-right fz13">金额</label>
				    <div class="col-sm-7" id='fee'>
				    	
				    </div>
                    <div class="clearfix"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                <button type="submit" class="btn btn-primary" onclick="doAddTestFee()">确定</button>
            </div>
        </form>
        </div><!-- /.modal-content -->
    </div><!-- /.modal -->

<script src="__PUBLIC__/static/js/jquery.form.js"></script>
<script type="text/javascript">
		//生成中心编码
		makeCentreCode();
		$("input[name = 'testCategory']").change(function(){
			makeCentreCode();
		});
		
		//时间
		$(document).ready(function(){
			$('.f-datetime').datetimepicker({language:  'zh-CN',format:'yyyy-mm-dd',startView: 2,minView:2,	autoclose:true });
		});	
		
		function makeCentreCode(){
			var nowDate = new Date();
			var year = nowDate.getFullYear();
			var month = nowDate.getMonth()+1;
			month = month<10?'0'+month:month;
			var department = 'B';
			var type = $('input:radio[name="testCategory"]:checked').val();
			type = (type == '委托检验')?'W':'C';
			var code= '101';
			//获取最新编码
			$.ajax({
				url: "{:U('/admin/contract/getLastCode')}",
				dataType: 'json',			
				data:{"year":year,"month":month},
				async: false,
				success: function (res) {
					//var _options = {"text":"aaa！"};
					//_options.text = data.re;
					//doAlertDialog(_options);
					if(res.re!='none'){
						code = res.re;
						code = parseInt(code.substring(8,11))+1;
					}
				}
			});
			
			var centreCode = year+""+month+department+type+code;
			$('input[name="centreNo"]').val(centreCode);
			if(type=='W'){
				$("#sampling_list").css("display","none");
			}else{	
				$("#sampling_list").css("display","inline-block");
			}
		}
		
		function upVIPCode(){
			if($("input[name='ifHighQuantity']").is(':checked')){
				var nowDate = new Date();
				var year = nowDate.getFullYear();
				var month = nowDate.getMonth()+1;
				month = month<10?'0'+month:month;
				var department = 'B';
				var type = $('input:radio[name="testCategory"]:checked').val();
				type = (type == '委托检验')?'W':'C';
				var code='001';
				var remain;//剩余优质编号
				$.ajax({
					url:"{:U('/admin/contract/getHighCode')}",
					dataType:"json",
					data:{"year":year,"month":month},
					async:false,
					success:function(res){
						if(res.re!='none'){
							code = res.re;
							code = parseInt(code.substring(8,11))+1;
							//保持后面编码为三位数，不够补零
							code = (Array(3).join('0') + code).slice(-3);
						}
					}
				});
							
				var centreCode = year+""+month+department+type+code;
				remain = 100-code+1;
				$('input[name="centreNo"]').val(centreCode);
				$('input[name="ifHighQuantity"]').val(1);
				$("#remain").html(remain+"(含当前编号)");
				$("#remainCode").css("display","block");
			}else{
				makeCentreCode();
				$('input[name="ifHighQuantity"]').val(0);
				$("#remainCode").css("display","none");
				
			}
		}
		
		//D部门费用选择函数--测试
		function dCost1(){
			var modal = $("#editModal");
			modal.modal();
			computeSum();
		}
		
		//本部门费用选择--测试
		function myCost1(){
			var modal = $("#editModal");		
			setMetOption();
			modal.modal();
			computeSum();
		}
		
		
		//实时计算总费用
		function computeSum(){
			if($("#myCost").val()!="" && $("#dCost").val()!="" && $("#copyCost").val()!="" && $("#editCost").val()!="" && $.trim($("#myCost").val()).length>0 && $.trim($("#dCost").val()).length>0 && $.trim($("#copyCost").val()).length>0 && $.trim($("#editCost").val()).length>0){
				$("#sumCost").val(parseInt($("#myCost").val())+parseInt($("#dCost").val())+parseInt($("#editCost").val())+parseInt($("#copyCost").val()));
			}
			
		}
		
		//合同入库
		function doInputContract(){
			//alert('start');
			var options = {
				url: "{:U('/admin/contract/doAddContract')}",
				dataType: 'json',
				beforeSubmit: function(){
					return true;
				},
				success: function (data) {
					if(data.msg=='succ'){
						var _options = {"text":"录入成功！","action":function(){window.location.reload();}};
						doAlertDialog(_options);
					}else{
						var _options = {"text":"录入失败！"};
						if(data.msg) _options.text = data.msg;
						doAlertDialog(_options);
					}
				}
			};
			$("#form2").ajaxForm(options);
			return false;
		}
		
		//获取费用选项(下面三个函数)
		function setMetOption(){
			$.ajax({
				url: "{:U('/admin/contract/findMetList')}",
				dataType: 'json',
				beforeSubmit: function(){
					return true;
				},
				success: function (re) {
					data = re['meterial_list'];
					for(var i=0;i<data.length;i++){
						var meterial = data[i]['meterial'];
						option = "<option value='"+meterial+"'>"+meterial+"</option>";
						$('#meterial').append(option);
					}
				}	
			});
		}
		
		function setProOption(){
			m_select = $("#meterial").val();
			if(m_select!=0){
				$.ajax({
					url: "{:U('/admin/contract/findProList')}",
					dataType: 'json',
					data:{'m_select':m_select},
					beforeSubmit: function(){
						return true;
					},
					success: function (re) {
						$('#productname').find("option").remove();
						var option = "<option value=0>请选择</option>";
						$('#productname').append(option);
						data = re['productname_list'];
						for(var i=0;i<data.length;i++){
							var productname = data[i]['productname'];
							option = "<option value='"+productname+"'>"+productname+"</option>";
							$('#productname').append(option);
						}
					}	
				});
			}else{
				$('#productname').find("option").remove();
				var option = "<option value=0>请选择</option>";
				$('#productname').append(option);
			}
		}

		function setItemOption(){
			m_select = $("#meterial").val();
			p_select = $("#productname").val();
			if(m_select!=0){
				$.ajax({
					url: "{:U('/admin/contract/findItemList')}",
					dataType: 'json',
					data:{'m_select':m_select,'p_select':p_select},
					beforeSubmit: function(){
						return true;
					},
					success: function (re) {
						data = re['item_list'];
						for(var i=0;i<data.length;i++){
							var items = data[i]['item'];
							var money = data[i]['fee'];
							option = "<input type='checkbox' name='items' value='"+money+"'/>&nbsp;&nbsp;"+items+"&nbsp;&nbsp;";
							$('#items').append(option);
						}
					}	
				});
			}
		}
		
		//计算费用
		$("input[name='items']").click(function(){
			var cash=0;
			alert(cash);
			$("input[name='items']:checked").each(function(index, element) {
				cash+=element;
			});
			$("#fee").val(cash);
			alert(cash);	
		});
		
		
	</script>
</body>